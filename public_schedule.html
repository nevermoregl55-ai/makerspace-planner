<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Area 59 - Public Schedule</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #f1f5f9; }
        .calendar-day { min-height: 120px; }
        .event-slot {
            font-size: 0.8rem;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            color: white;
            margin-top: 0.25rem;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
            position: relative;
        }
        .event-slot.appointment { background-color: #64748b; } /* slate-500 */
        .event-slot.class-open { background-color: #22c55e; cursor: pointer; } /* green-500 */
        .event-slot.class-full { background-color: #ef4444; cursor: pointer; } /* red-500 */
        .event-slot.walk-in { background-color: #f59e0b; } /* amber-500 */
        #class-details-modal { display: none; }
    </style>
</head>
<body class="text-slate-800">

    <!-- Class Details Modal -->
    <div id="class-details-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div id="class-details-content" class="bg-white rounded-2xl shadow-lg p-8 w-full max-w-lg space-y-4 relative">
            <button id="close-class-details" class="absolute top-4 right-4 text-2xl font-bold text-slate-500 hover:text-slate-800">&times;</button>
            <!-- Details will be injected here -->
        </div>
    </div>

    <div class="container mx-auto p-4 sm:p-6 md:p-8">
        <header class="text-center mb-8 relative">
            <a href="index.html"><img src="Area_59_Logo_Color_3x1.png" alt="Area 59 Logo" class="mx-auto h-20 mb-4"></a>
            <h1 class="text-4xl font-bold text-slate-900">Makerspace Schedule</h1>
            <p class="text-slate-600 mt-2">View all scheduled classes, machine appointments, and walk-in hours.</p>
            <div class="mt-4 flex justify-center gap-4 text-sm flex-wrap">
                <span class="flex items-center gap-2"><div class="w-4 h-4 rounded-full bg-slate-500"></div> Booked Machine</span>
                <span class="flex items-center gap-2"><div class="w-4 h-4 rounded-full bg-green-500"></div> Class (Seats Open)</span>
                <span class="flex items-center gap-2"><div class="w-4 h-4 rounded-full bg-red-500"></div> Class (Full)</span>
                <span class="flex items-center gap-2"><div class="w-4 h-4 rounded-full bg-amber-500"></div> Walk-in Hours</span>
            </div>
        </header>

         <div class="flex items-center justify-center mb-6 gap-4">
            <button id="prev-month" class="px-4 py-2 bg-white rounded-lg shadow font-semibold">&larr;</button>
            <h2 id="month-year" class="text-2xl font-bold"></h2>
            <button id="next-month" class="px-4 py-2 bg-white rounded-lg shadow font-semibold">&rarr;</button>
        </div>

        <div id="calendar" class="grid grid-cols-7 gap-px bg-slate-200 border border-slate-200"></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, getDocs, doc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyA30A5Qh43IVxy0ZJnVTW9rtvYZG7Cp8-s",
            authDomain: "area-59-makerspace.firebaseapp.com",
            projectId: "area-59-makerspace",
            storageBucket: "area-59-makerspace.firebasestorage.app",
            messagingSenderId: "721728366959",
            appId: "1:721728366959:web:8a6513baa852e5699b609a",
            measurementId: "G-8RFF3XJWFL"
        };
        
        let db, currentDate = new Date(), allEvents = [];

        async function initialize() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                const auth = getAuth(app);
                await signInAnonymously(auth);
                
                await loadAllEvents();
                renderCalendar();
            } catch (error) { 
                console.error("Firebase Init Error:", error); 
                document.getElementById('calendar').innerHTML = '<p class="text-red-500 col-span-7 text-center p-4">Could not connect to the schedule service.</p>';
            }
        }

        async function loadAllEvents() {
            allEvents = [];
            const classesQuery = getDocs(collection(db, "classes"));
            const appointmentsQuery = getDocs(collection(db, "public_appointments"));
            const walkInQuery = getDoc(doc(db, "walk_in_hours", "schedule"));

            const [classesSnapshot, appointmentsSnapshot, walkInSnap] = await Promise.all([classesQuery, appointmentsQuery, walkInQuery]);

            classesSnapshot.forEach((doc) => {
                allEvents.push({ id: doc.id, type: 'class', ...doc.data() });
            });
            appointmentsSnapshot.forEach((doc) => {
                allEvents.push({ id: doc.id, type: 'appointment', ...doc.data() });
            });
            if (walkInSnap.exists()) {
                walkInSnap.data().hours.forEach(hour => {
                    allEvents.push({ type: 'walk-in', ...hour });
                });
            }
        }

        function renderCalendar() {
            const calendarEl = document.getElementById('calendar');
            calendarEl.innerHTML = '';
            
            const month = currentDate.getMonth();
            const year = currentDate.getFullYear();
            
            document.getElementById('month-year').textContent = `${currentDate.toLocaleString('default', { month: 'long' })} ${year}`;

            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            
            ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].forEach(day => {
                calendarEl.innerHTML += `<div class="text-center font-bold p-2 bg-slate-100">${day}</div>`;
            });

            for (let i = 0; i < firstDay; i++) calendarEl.appendChild(document.createElement('div'));

            for (let day = 1; day <= daysInMonth; day++) {
                const dayEl = document.createElement('div');
                dayEl.className = 'calendar-day p-2 bg-white relative';
                dayEl.innerHTML = `<span class="font-semibold">${day}</span>`;

                const todayStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const dayEvents = allEvents.filter(e => e.date === todayStr);
                
                dayEvents.sort((a,b) => a.startTime.localeCompare(b.startTime));

                dayEvents.forEach(event => {
                    const eventDiv = document.createElement('div');
                    eventDiv.className = 'event-slot';
                    
                    if (event.type === 'class') {
                        const isFull = event.hasOwnProperty('currentSize') && event.maxSize && event.currentSize >= event.maxSize;
                        eventDiv.classList.add(isFull ? 'class-full' : 'class-open');
                        eventDiv.textContent = `${event.startTime} - ${event.name}`;
                        eventDiv.dataset.eventId = event.id;
                    } else if (event.type === 'appointment') {
                        eventDiv.classList.add('appointment');
                        eventDiv.textContent = `${event.startTime} - ${event.machine}`;
                    } else if (event.type === 'walk-in') {
                         eventDiv.classList.add('walk-in');
                         eventDiv.textContent = `Walk-in: ${event.startTime} - ${event.endTime}`;
                    }
                    dayEl.appendChild(eventDiv);
                });
                
                calendarEl.appendChild(dayEl);
            }
        }
        
        // --- Modal Logic ---
        const classDetailsModal = document.getElementById('class-details-modal');
        const classDetailsContent = document.getElementById('class-details-content');

        document.getElementById('calendar').addEventListener('click', e => {
            const eventSlot = e.target.closest('.event-slot');
            if (eventSlot && (eventSlot.classList.contains('class-open') || eventSlot.classList.contains('class-full'))) {
                const eventId = eventSlot.dataset.eventId;
                const eventData = allEvents.find(e => e.id === eventId);
                if (eventData) {
                    const isFull = eventData.hasOwnProperty('currentSize') && eventData.maxSize && eventData.currentSize >= eventData.maxSize;
                    let seatsHTML;
                    let registrationHTML = '';

                    if (isFull) {
                        seatsHTML = `<p><span class="font-semibold">Seats:</span> <span class="font-bold text-red-600">This class is full.</span></p>`;
                        registrationHTML = `<button disabled class="block w-full text-center mt-4 px-4 py-3 font-semibold text-white bg-slate-400 rounded-lg cursor-not-allowed">Sold Out</button>`;
                    } else {
                        const seatsLeft = eventData.maxSize - eventData.currentSize;
                        seatsHTML = `<p><span class="font-semibold">Seats Available:</span> ${seatsLeft} of ${eventData.maxSize}</p>`;
                        if (eventData.registrationLink) {
                            registrationHTML = `<a href="${eventData.registrationLink}" target="_blank" class="block w-full text-center mt-4 px-4 py-3 font-semibold text-white bg-blue-600 rounded-lg hover:bg-blue-700">Register Now</a>`;
                        }
                    }

                    classDetailsContent.innerHTML = `
                        <button id="close-class-details" class="absolute top-4 right-4 text-2xl font-bold text-slate-500 hover:text-slate-800">&times;</button>
                        <h2 class="text-2xl font-bold">${eventData.name}</h2>
                        <p class="text-slate-600">${eventData.description || 'No description available.'}</p>
                        <div class="text-lg space-y-1">
                            <p><span class="font-semibold">When:</span> ${new Date(eventData.date + 'T00:00:00').toLocaleDateString(undefined, { weekday: 'long', month: 'long', day: 'numeric' })}</p>
                            <p><span class="font-semibold">Time:</span> ${eventData.startTime} - ${eventData.endTime}</p>
                            ${seatsHTML}
                        </div>
                        ${registrationHTML}
                    `;
                    classDetailsModal.style.display = 'flex';
                }
            }
        });

        classDetailsModal.addEventListener('click', e => {
            if (e.target.id === 'class-details-modal' || e.target.id === 'close-class-details') {
                classDetailsModal.style.display = 'none';
            }
        });

        document.getElementById('prev-month').addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth() - 1); renderCalendar(); });
        document.getElementById('next-month').addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth() + 1); renderCalendar(); });

        initialize();
    </script>
</body>
</html>

