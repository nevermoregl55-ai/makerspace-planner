<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Area 59 - 3D Printer Project Entry</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            background-image: url('GCC-Sunset-7.jpg');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
        }
        .content-panel {
            background-color: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
        }
        .login-panel {
            background-color: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }
        #main-content { display: none; }
        .image-preview-container {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            margin-top: 1rem;
        }
        .image-preview {
            position: relative;
            width: 120px;
            height: 120px;
        }
        .image-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 0.5rem;
            border: 2px solid #e5e7eb;
        }
    </style>
</head>
<body class="text-slate-800">

    <div id="login-screen" class="min-h-screen flex items-center justify-center p-4">
        <div class="w-full max-w-md p-8 space-y-6 rounded-2xl shadow-lg login-panel">
            <div class="text-center">
                <img src="Area_59_Logo_Color_3x1.png" alt="Area 59 Logo" class="mx-auto h-16 mb-4">
                <h1 class="text-2xl font-bold text-slate-900">Project Database Access</h1>
                <p class="text-slate-600">Enter the admin password to continue.</p>
            </div>
            <form id="login-form" class="space-y-4">
                <div>
                    <input type="password" id="password-input" placeholder="Password" required class="w-full px-4 py-2 text-slate-900 bg-slate-50 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none transition">
                </div>
                <button type="submit" class="w-full px-4 py-2 font-semibold text-white bg-blue-600 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition">Unlock</button>
            </form>
            <p id="login-error" class="text-red-500 text-sm text-center hidden">Incorrect password. Please try again.</p>
            <div class="text-center">
                <a href="add_project.html" class="text-sm text-blue-600 hover:underline">&larr; Back to Project Type Selection</a>
            </div>
        </div>
    </div>

    <div id="main-content" class="container mx-auto max-w-4xl p-4 sm:p-6 md:p-8">
        <div id="error-banner" class="hidden bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded-lg mb-6" role="alert">
            <p class="font-bold">Loading Error</p>
            <p id="error-message"></p>
        </div>
        <header class="text-center mb-8 relative p-6 rounded-xl content-panel shadow-md">
            <div class="relative">
                <h1 class="text-4xl font-bold text-slate-900">3D Printer Project Entry</h1>
                <p class="text-slate-700 mt-2 max-w-3xl mx-auto">Add a new completed 3D printer project to the database.</p>
            </div>
        </header>

        <div class="content-panel p-8 rounded-xl shadow-lg space-y-6">
            <!-- Project Details -->
            <div class="space-y-4">
                <h2 class="text-2xl font-semibold border-b pb-2">Project Details</h2>
                <div>
                    <label for="projectName" class="block text-sm font-medium text-slate-700">Project Name</label>
                    <input type="text" id="projectName" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                </div>
                 <div>
                    <label for="printerUsed" class="block text-sm font-medium text-slate-700">Printer Used</label>
                    <select id="printerUsed" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        <option>Loading printers...</option>
                    </select>
                </div>
                <div>
                    <label for="projectDescription" class="block text-sm font-medium text-slate-700">Description / Notes</label>
                    <textarea id="projectDescription" rows="4" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"></textarea>
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700">Dimensions</label>
                    <div class="grid grid-cols-1 sm:grid-cols-4 gap-4 mt-1">
                        <input type="number" id="dimL" placeholder="Length" class="rounded-md border-slate-300 shadow-sm">
                        <input type="number" id="dimW" placeholder="Width" class="rounded-md border-slate-300 shadow-sm">
                        <input type="number" id="dimH" placeholder="Height" class="rounded-md border-slate-300 shadow-sm">
                         <select id="dimUnit" class="rounded-md border-slate-300 shadow-sm">
                            <option>mm</option>
                            <option>inches</option>
                            <option>cm</option>
                        </select>
                    </div>
                </div>
                 <div>
                    <label class="block text-sm font-medium text-slate-700">Print Time</label>
                     <div class="grid grid-cols-2 gap-4 mt-1">
                        <input type="number" id="buildTimeHours" placeholder="Hours" class="rounded-md border-slate-300 shadow-sm">
                        <input type="number" id="buildTimeMinutes" placeholder="Minutes" class="rounded-md border-slate-300 shadow-sm">
                    </div>
                </div>
            </div>
            
             <!-- Post-Processing -->
            <div class="space-y-4 pt-4 border-t">
                <h3 class="text-2xl font-semibold border-b pb-2">Post-Processing</h3>
                <div>
                    <label for="assemblyRequired" class="block text-sm font-medium text-slate-700">Was Assembly Required?</label>
                    <select id="assemblyRequired" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        <option>No</option>
                        <option>Yes</option>
                    </select>
                </div>
                <div id="assembly-time-container" class="hidden">
                    <label class="block text-sm font-medium text-slate-700">Assembly Time</label>
                     <div class="grid grid-cols-2 gap-4 mt-1">
                        <input type="number" id="assemblyTimeHours" placeholder="Hours" class="rounded-md border-slate-300 shadow-sm">
                        <input type="number" id="assemblyTimeMinutes" placeholder="Minutes" class="rounded-md border-slate-300 shadow-sm">
                    </div>
                </div>
            </div>

            <!-- Print Settings -->
            <div class="space-y-4">
                <h2 class="text-2xl font-semibold border-b pb-2">Print Settings</h2>
                 <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-4">
                    <div>
                        <label for="material" class="block text-sm font-medium text-slate-700">Material</label>
                        <input type="text" id="material" placeholder="e.g., PLA, PETG, ABS" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm">
                    </div>
                    <div>
                        <label for="layerHeight" class="block text-sm font-medium text-slate-700">Layer Height (mm)</label>
                        <input type="number" step="0.01" id="layerHeight" placeholder="e.g., 0.2" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm">
                    </div>
                    <div>
                        <label for="infill" class="block text-sm font-medium text-slate-700">Infill (%)</label>
                        <input type="number" id="infill" placeholder="e.g., 15" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm">
                    </div>
                    <div>
                        <label for="supports" class="block text-sm font-medium text-slate-700">Used Supports?</label>
                        <select id="supports" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm">
                            <option>No</option>
                            <option>Yes</option>
                        </select>
                    </div>
                    <div>
                        <label for="wallThickness" class="block text-sm font-medium text-slate-700">Wall Thickness (mm)</label>
                        <input type="number" step="0.1" id="wallThickness" placeholder="e.g., 0.8" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm">
                    </div>
                    <div>
                        <label for="nozzleSize" class="block text-sm font-medium text-slate-700">Nozzle Size (mm)</label>
                        <input type="number" step="0.1" id="nozzleSize" placeholder="e.g., 0.4" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm">
                    </div>
                    <div>
                        <label for="printSpeed" class="block text-sm font-medium text-slate-700">Print Speed (mm/s)</label>
                        <input type="number" id="printSpeed" placeholder="e.g., 50" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm">
                    </div>
                </div>
            </div>

            <!-- Image Upload -->
            <div>
                 <h2 class="text-2xl font-semibold border-b pb-2">Project Images</h2>
                 <label for="projectImages" class="block text-sm font-medium text-slate-700 mt-4">Upload one or more images</label>
                 <input type="file" id="projectImages" multiple accept="image/*" class="mt-1 block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                 <div id="image-previews" class="image-preview-container"></div>
            </div>

             <!-- Save Button -->
            <div class="text-center pt-6">
                <button id="save-project-btn" class="w-full max-w-xs px-6 py-3 font-semibold text-white bg-blue-600 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition shadow-lg">Save Project & Download File</button>
                <p id="save-status" class="text-green-600 mt-4 font-medium hidden"></p>
            </div>
        </div>
    </div>

    <script>
        // --- Authentication ---
        const password = "Pronghorn@59";
        const loginForm = document.getElementById('login-form');
        const passwordInput = document.getElementById('password-input');
        const loginError = document.getElementById('login-error');
        const loginScreen = document.getElementById('login-screen');
        const mainContent = document.getElementById('main-content');
        const printerUsedSelect = document.getElementById('printerUsed');

        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            if (passwordInput.value === password) {
                loginScreen.style.display = 'none';
                mainContent.style.display = 'block';
                loadPrinters();
            } else {
                loginError.classList.remove('hidden');
                passwordInput.value = '';
            }
        });

        async function loadPrinters() {
            try {
                const response = await fetch('inventory.json?v=' + Date.now());
                if (!response.ok) throw new Error('Could not load inventory file. Make sure it is in the same folder.');
                const inventory = await response.json();
                const printers = inventory["3D Printing & Scanning"]?.items || [];

                printerUsedSelect.innerHTML = '';
                if (printers.length === 0) {
                    printerUsedSelect.innerHTML = '<option>No printers found in inventory.json</option>';
                    return;
                }

                printers.forEach(printer => {
                    const option = document.createElement('option');
                    option.value = printer;
                    option.textContent = printer;
                    printerUsedSelect.appendChild(option);
                });

            } catch (error) {
                console.error(error);
                printerUsedSelect.innerHTML = `<option>Error loading printers</option>`;
                const errorBanner = document.getElementById('error-banner');
                const errorMessage = document.getElementById('error-message');
                errorMessage.innerHTML = `Could not load <strong>inventory.json</strong>. This usually happens when you open the HTML file directly from your computer. <br><br><strong>Solution:</strong> You must serve these files using a local web server. If you have Python installed, you can run <code>python -m http.server</code> in this folder from your terminal.`;
                errorBanner.classList.remove('hidden');
            }
        }

        // --- Image Previews ---
        const imageInput = document.getElementById('projectImages');
        const imagePreviewsContainer = document.getElementById('image-previews');
        
        imageInput.addEventListener('change', () => {
            imagePreviewsContainer.innerHTML = '';
            const files = imageInput.files;
            if (files) {
                Array.from(files).forEach(file => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const previewWrapper = document.createElement('div');
                        previewWrapper.className = 'image-preview';
                        
                        const img = document.createElement('img');
                        img.src = e.target.result;
                        
                        previewWrapper.appendChild(img);
                        imagePreviewsContainer.appendChild(previewWrapper);
                    };
                    reader.readAsDataURL(file);
                });
            }
        });
        
        // --- Assembly Time Logic ---
        const assemblyRequiredSelect = document.getElementById('assemblyRequired');
        const assemblyTimeContainer = document.getElementById('assembly-time-container');

        assemblyRequiredSelect.addEventListener('change', () => {
            if (assemblyRequiredSelect.value === 'Yes') {
                assemblyTimeContainer.classList.remove('hidden');
            } else {
                assemblyTimeContainer.classList.add('hidden');
                document.getElementById('assemblyTimeHours').value = '';
                document.getElementById('assemblyTimeMinutes').value = '';
            }
        });

        // --- Save Project Data ---
        const saveBtn = document.getElementById('save-project-btn');
        const saveStatus = document.getElementById('save-status');

        async function getBase64Images(files) {
            const promises = Array.from(files).map(file => {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result);
                    reader.onerror = error => reject(error);
                    reader.readAsDataURL(file);
                });
            });
            return Promise.all(promises);
        }

        saveBtn.addEventListener('click', async () => {
            saveStatus.classList.add('hidden');
            saveBtn.disabled = true;
            saveBtn.textContent = 'Saving...';
            
            try {
                // 1. Collect Data
                const images = await getBase64Images(imageInput.files);
                const buildHours = document.getElementById('buildTimeHours').value || 0;
                const buildMinutes = document.getElementById('buildTimeMinutes').value || 0;
                const totalBuildTime = parseInt(buildHours) * 60 + parseInt(buildMinutes);

                const assemblyHours = document.getElementById('assemblyTimeHours').value || 0;
                const assemblyMinutes = document.getElementById('assemblyTimeMinutes').value || 0;
                const totalAssemblyTime = parseInt(assemblyHours) * 60 + parseInt(assemblyMinutes);

                const newProject = {
                    id: Date.now().toString(),
                    type: '3d-printer',
                    name: document.getElementById('projectName').value,
                    machineUsed: document.getElementById('printerUsed').value,
                    description: document.getElementById('projectDescription').value,
                    dimensions: {
                        l: document.getElementById('dimL').value,
                        w: document.getElementById('dimW').value,
                        h: document.getElementById('dimH').value,
                        unit: document.getElementById('dimUnit').value,
                    },
                    buildTimeMinutes: totalBuildTime,
                    assemblyRequired: document.getElementById('assemblyRequired').value,
                    assemblyTimeMinutes: totalAssemblyTime,
                    images: images,
                    printSettings: {
                        material: document.getElementById('material').value,
                        layerHeight: document.getElementById('layerHeight').value,
                        infill: document.getElementById('infill').value,
                        supports: document.getElementById('supports').value,
                        wallThickness: document.getElementById('wallThickness').value,
                        nozzleSize: document.getElementById('nozzleSize').value,
                        printSpeed: document.getElementById('printSpeed').value,
                    },
                    dateAdded: new Date().toISOString()
                };

                // 2. Load existing projects
                let projects = [];
                try {
                    const response = await fetch('projects.json');
                    if (response.ok) {
                        projects = await response.json();
                    }
                } catch (e) {
                    console.log("No existing projects.json found, creating a new one.");
                }

                // 3. Add new project and prepare for download
                projects.push(newProject);
                const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(projects, null, 2));
                
                // 4. Trigger Download
                const downloadAnchorNode = document.createElement('a');
                downloadAnchorNode.setAttribute("href", dataStr);
                downloadAnchorNode.setAttribute("download", "projects.json");
                document.body.appendChild(downloadAnchorNode);
                downloadAnchorNode.click();
                downloadAnchorNode.remove();

                saveStatus.textContent = 'Project saved! The "projects.json" file has been downloaded.';
                saveStatus.classList.remove('hidden');

            } catch (error) {
                console.error("Error saving project:", error);
                saveStatus.textContent = 'An error occurred. Please check the console.';
                saveStatus.classList.remove('hidden');
            } finally {
                saveBtn.disabled = false;
                saveBtn.textContent = 'Save Project & Download File';
            }
        });
    </script>
</body>
</html>

