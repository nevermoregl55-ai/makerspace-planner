<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Area 59 - Manage Members</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            background-image: url('GCC-Sunset-7.jpg');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
        }
        .content-panel, .login-panel {
            background-color: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
        }
        #main-content { display: none; }
        .member-item:hover {
            background-color: rgba(239, 246, 255, 1); /* blue-50 */
        }
    </style>
</head>
<body class="text-slate-800">

    <div id="login-screen" class="min-h-screen flex items-center justify-center p-4">
        <div class="w-full max-w-md p-8 space-y-6 rounded-2xl shadow-lg login-panel">
            <h1 class="text-2xl font-bold text-slate-900 text-center">Admin Access</h1>
            <form id="login-form" class="space-y-4">
                <input type="password" id="password-input" placeholder="Password" required class="w-full px-4 py-2 rounded-lg border-slate-300">
                <button type="submit" class="w-full px-4 py-2 font-semibold text-white bg-blue-600 rounded-lg hover:bg-blue-700">Unlock</button>
            </form>
            <p id="login-error" class="text-red-500 text-sm text-center hidden"></p>
            <div class="text-center">
                <a href="admin.html" class="text-sm text-blue-600 hover:underline">&larr; Back to Admin Dashboard</a>
            </div>
        </div>
    </div>

    <div id="main-content" class="container mx-auto max-w-6xl p-4 sm:p-6 md:p-8">
        <header class="text-center mb-8 p-6 rounded-xl content-panel shadow-md">
            <h1 class="text-4xl font-bold text-slate-900">Manage Members</h1>
            <p class="text-slate-700 mt-2">Create new member accounts and view/edit existing member information.</p>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Member List -->
            <div class="lg:col-span-1 content-panel p-6 rounded-xl shadow-lg">
                <h2 class="text-2xl font-bold mb-4">Member List</h2>
                <div id="member-list" class="space-y-2 h-96 overflow-y-auto">
                    <p>Loading members...</p>
                </div>
            </div>

            <!-- Member Form -->
            <div class="lg:col-span-2 content-panel p-6 rounded-xl shadow-lg">
                <h2 id="form-title" class="text-2xl font-bold mb-4">Add New Member</h2>
                <form id="member-form" class="space-y-4">
                    <input type="hidden" id="member-id">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="member-name" class="block text-sm font-medium">Full Name</label>
                            <input type="text" id="member-name" required class="mt-1 block w-full rounded-md border-slate-300">
                        </div>
                        <div>
                            <label for="member-phone" class="block text-sm font-medium">Phone Number</label>
                            <input type="tel" id="member-phone" class="mt-1 block w-full rounded-md border-slate-300">
                        </div>
                    </div>
                    <div>
                        <label for="member-address" class="block text-sm font-medium">Address</label>
                        <input type="text" id="member-address" class="mt-1 block w-full rounded-md border-slate-300">
                    </div>
                    <hr class="my-4">
                    <h3 class="text-lg font-semibold">Login Credentials</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="member-email" class="block text-sm font-medium">Email (for login)</label>
                            <input type="email" id="member-email" required class="mt-1 block w-full rounded-md border-slate-300">
                        </div>
                        <div>
                            <label for="member-password" class="block text-sm font-medium">Password</label>
                            <input type="password" id="member-password" required class="mt-1 block w-full rounded-md border-slate-300">
                        </div>
                    </div>
                    <div class="pt-4 flex items-center gap-4">
                        <button type="submit" id="save-member-btn" class="px-6 py-2 font-semibold text-white bg-blue-600 rounded-lg hover:bg-blue-700">Save Member</button>
                        <button type="button" id="clear-form-btn" class="px-4 py-2 font-semibold text-slate-700 bg-slate-200 rounded-lg hover:bg-slate-300">New Member</button>
                        <button type="button" id="delete-member-btn" class="hidden px-4 py-2 font-semibold text-white bg-red-600 rounded-lg hover:bg-red-700">Delete Member</button>
                    </div>
                </form>
                <p id="form-status" class="mt-4 h-6 font-medium"></p>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, getDocs, doc, setDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyA30A5Qh43IVxy0ZJnVTW9rtvYZG7Cp8-s",
            authDomain: "area-59-makerspace.firebaseapp.com",
            projectId: "area-59-makerspace",
            storageBucket: "area-59-makerspace.firebasestorage.app",
            messagingSenderId: "721728366959",
            appId: "1:721728366959:web:8a6513baa852e5699b609a",
            measurementId: "G-8RFF3XJWFL"
        };
        
        let db, auth;
        let isFirebaseConnected = false;

        const loginForm = document.getElementById('login-form');
        const loginError = document.getElementById('login-error');

        document.addEventListener('DOMContentLoaded', async () => {
             try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                await signInAnonymously(auth);
                isFirebaseConnected = true;
            } catch (error) {
                loginError.textContent = "Could not connect to Firebase.";
                loginError.classList.remove('hidden');
            }
        });
        
        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            if (document.getElementById('password-input').value === "Pronghorn@59" && isFirebaseConnected) {
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('main-content').style.display = 'block';
                loadMembers();
            } else {
                loginError.classList.remove('hidden');
            }
        });

        const memberList = document.getElementById('member-list');
        const memberForm = document.getElementById('member-form');
        const formTitle = document.getElementById('form-title');
        const formStatus = document.getElementById('form-status');
        const deleteBtn = document.getElementById('delete-member-btn');
        const memberIdInput = document.getElementById('member-id');
        const memberEmailInput = document.getElementById('member-email');
        const memberPasswordInput = document.getElementById('member-password');

        async function loadMembers() {
            memberList.innerHTML = '<p>Loading members...</p>';
            try {
                const querySnapshot = await getDocs(collection(db, "members"));
                memberList.innerHTML = '';
                if (querySnapshot.empty) {
                    memberList.innerHTML = '<p class="text-slate-500">No members found.</p>';
                    return;
                }
                querySnapshot.forEach((doc) => {
                    const member = doc.data();
                    const memberEl = document.createElement('div');
                    memberEl.className = 'member-item p-2 rounded-md cursor-pointer border border-transparent hover:border-blue-300';
                    memberEl.textContent = member.name || member.email;
                    memberEl.dataset.id = doc.id;
                    memberList.appendChild(memberEl);
                });
            } catch (error) {
                console.error("Error loading members:", error);
                memberList.innerHTML = '<p class="text-red-500">Error loading members.</p>';
            }
        }

        memberList.addEventListener('click', async (e) => {
            if (e.target.classList.contains('member-item')) {
                const id = e.target.dataset.id;
                const memberData = (await getDoc(doc(db, 'members', id))).data();
                if(memberData) {
                    formTitle.textContent = "Edit Member Details";
                    memberIdInput.value = id;
                    document.getElementById('member-name').value = memberData.name || '';
                    document.getElementById('member-phone').value = memberData.phone || '';
                    document.getElementById('member-address').value = memberData.address || '';
                    memberEmailInput.value = memberData.email || '';
                    memberEmailInput.disabled = true;
                    memberPasswordInput.disabled = true;
                    memberPasswordInput.required = false;
                    memberPasswordInput.placeholder = "Password cannot be changed here";
                    deleteBtn.classList.remove('hidden');
                }
            }
        });
        
        memberForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = memberIdInput.value;
            formStatus.textContent = 'Saving...';

            const memberData = {
                name: document.getElementById('member-name').value,
                phone: document.getElementById('member-phone').value,
                address: document.getElementById('member-address').value,
                email: memberEmailInput.value,
            };

            try {
                if (id) { // Editing existing member
                    await setDoc(doc(db, 'members', id), memberData, { merge: true });
                    formStatus.textContent = "Member updated successfully!";
                } else { // Creating new member
                    const userCredential = await createUserWithEmailAndPassword(auth, memberData.email, memberPasswordInput.value);
                    const userId = userCredential.user.uid;
                    await setDoc(doc(db, 'members', userId), memberData);
                    formStatus.textContent = "New member account created!";
                }
                loadMembers();
                clearForm();
            } catch (error) {
                console.error("Error saving member:", error);
                formStatus.textContent = error.message;
            } finally {
                setTimeout(() => formStatus.textContent = '', 5000);
            }
        });

        document.getElementById('clear-form-btn').addEventListener('click', clearForm);

        function clearForm() {
            formTitle.textContent = "Add New Member";
            memberForm.reset();
            memberIdInput.value = '';
            memberEmailInput.disabled = false;
            memberPasswordInput.disabled = false;
            memberPasswordInput.required = true;
            memberPasswordInput.placeholder = "";
            deleteBtn.classList.add('hidden');
        }
        
        deleteBtn.addEventListener('click', async () => {
            const id = memberIdInput.value;
            if (id && confirm(`Are you sure you want to delete this member's profile? \n\nIMPORTANT: This will only delete their profile data (name, address, etc.). For security, you must delete their login account from the Firebase Console.`)) {
                try {
                    await deleteDoc(doc(db, 'members', id));
                    formStatus.textContent = "Member profile deleted.";
                    loadMembers();
                    clearForm();
                } catch (error) {
                    console.error("Error deleting member data:", error);
                    formStatus.textContent = "Error deleting profile.";
                }
            }
        });

    </script>
</body>
</html>

