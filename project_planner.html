<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Area 59 - AI Project Planner</title>
    <script src="https://cdn.tailwindcss.com/"></script>
    <style>
        body {
            background-image: url('GCC-Sunset-7.jpg');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
        }
        .content-panel {
            background-color: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
        }
         #ai-plan-container { display: none; }
        .tab-button {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            background-color: rgba(255, 255, 255, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.4);
        }
        .tab-button.active {
            background-color: #2563eb; /* blue-600 */
            color: white;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .image-preview-container {
            width: 200px;
            height: 200px;
            border: 2px dashed #9ca3af;
            border-radius: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: rgba(255, 255, 255, 0.2);
            overflow: hidden;
        }
        .image-preview-container img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .skill-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.875rem;
            font-weight: 500;
        }
    </style>
</head>
<body class="text-slate-800">

    <div class="container mx-auto max-w-5xl p-4 sm:p-6 md:p-8">
        <header class="text-center mb-8 relative p-6 rounded-xl content-panel shadow-md">
            <img src="Area_59_Logo_Color_3x1.png" alt="Area 59 Logo" class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 h-32 opacity-50">
            <div class="relative">
                <h1 class="text-4xl font-bold text-slate-900">AI Project Planner</h1>
                <p class="text-slate-700 mt-2 max-w-3xl mx-auto">Welcome to the Area 59 AI Project Planner! Describe your project idea, upload an optional image, and our AI will generate a comprehensive plan tailored to the tools and equipment available in our makerspace.</p>
            </div>
        </header>

         <div id="inventory-error-banner" class="hidden bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded-lg mb-6" role="alert">
             <p class="font-bold">Inventory Error</p>
             <p>Could not load the makerspace inventory file (`inventory.json`). The feasibility check will be disabled.</p>
        </div>


        <!-- Input Section -->
        <div class="content-panel p-8 rounded-xl shadow-lg">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                <div class="md:col-span-2 space-y-4">
                    <h2 class="text-2xl font-semibold">Describe Your Project</h2>
                    <p class="text-slate-600">Be as descriptive as possible. What do you want to make? What materials will you use? The more detail you provide, the better the plan will be.</p>
                    <textarea id="user-description-input" rows="8" class="w-full p-3 rounded-lg border border-slate-300 shadow-sm focus:ring-2 focus:ring-blue-500 focus:outline-none" placeholder="e.g., I want to build a small bookshelf out of plywood. It should be about 3 feet tall and have two shelves..."></textarea>
                </div>
                <div class="space-y-4 flex flex-col items-center">
                    <h2 class="text-2xl font-semibold">Upload an Image (Optional)</h2>
                    <div id="image-preview" class="image-preview-container">
                        <span id="image-placeholder" class="text-slate-500">Click to upload</span>
                    </div>
                    <input type="file" id="image-upload-input" class="hidden" accept="image/*">
                    <button id="upload-button" class="w-full px-4 py-2 font-semibold text-white bg-slate-600 rounded-lg hover:bg-slate-700">Choose Image</button>
                </div>
            </div>
            <div class="text-center mt-8">
                <button id="generate-plan-btn" class="px-8 py-4 font-bold text-xl text-white bg-blue-600 rounded-lg hover:bg-blue-700 disabled:bg-slate-400 transition shadow-lg">Generate Plan</button>
                <p id="status-message" class="mt-4 text-slate-600 font-medium h-6"></p>
            </div>
        </div>

        <!-- AI Plan Display -->
        <div id="ai-plan-container" class="mt-8 content-panel p-8 rounded-xl shadow-lg">
            <!-- Tabs -->
            <div class="flex flex-wrap gap-2 mb-6 border-b border-slate-300 pb-4">
                <button class="tab-button active" data-tab="overview">Overview</button>
                <button class="tab-button" data-tab="materials">Materials & Tools</button>
                <button class="tab-button" data-tab="plan">Step-by-Step Plan</button>
                <button class="tab-button" data-tab="safety">Safety</button>
            </div>

            <!-- Tab Content -->
            <div id="overview" class="tab-content active space-y-6"></div>
            <div id="materials" class="tab-content space-y-6"></div>
            <div id="plan" class="tab-content space-y-6"></div>
            <div id="safety" class="tab-content space-y-6"></div>
        </div>
    </div>

<script type="module">
    // --- State and Configuration ---
    const apiKey = 'AIzaSyAUnpeih5PP95SGtgsC8nsQ1WC7ZSxyot8'; // API Key hard-coded here
    let imageBase64 = null;
    let inventoryData = null;

    // --- DOM Elements ---
    const userDescriptionInput = document.getElementById('user-description-input');
    const imageUploadInput = document.getElementById('image-upload-input');
    const uploadButton = document.getElementById('upload-button');
    const imagePreview = document.getElementById('image-preview');
    const generatePlanBtn = document.getElementById('generate-plan-btn');
    const statusMessage = document.getElementById('status-message');
    const aiPlanContainer = document.getElementById('ai-plan-container');
    const inventoryErrorBanner = document.getElementById('inventory-error-banner');

    // --- Initial Setup ---
    document.addEventListener('DOMContentLoaded', () => {
        loadInventory();
        checkGenerateButtonState();
    });

    async function loadInventory() {
        try {
            const response = await fetch(`inventory.json?v=${Date.now()}`);
            if (!response.ok) throw new Error('Network response was not ok');
            inventoryData = await response.json();
            console.log("Inventory loaded successfully.");
        } catch (error) {
            console.error("Failed to load inventory:", error);
            inventoryErrorBanner.classList.remove('hidden');
            inventoryData = null; // Ensure it's null on failure
        }
    }


    // --- Event Listeners ---
    uploadButton.addEventListener('click', () => imageUploadInput.click());
    imagePreview.addEventListener('click', () => imageUploadInput.click());

    imageUploadInput.addEventListener('change', (event) => {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                imageBase64 = e.target.result.split(',')[1];
                imagePreview.innerHTML = `<img src="${e.target.result}" alt="Project preview">`;
                checkGenerateButtonState();
            };
            reader.readAsDataURL(file);
        }
    });

    userDescriptionInput.addEventListener('keyup', checkGenerateButtonState);

    generatePlanBtn.addEventListener('click', generatePlan);

    // --- Core Functions ---
    function checkGenerateButtonState() {
        generatePlanBtn.disabled = !userDescriptionInput.value.trim();
    }

    async function generatePlan() {
        statusMessage.textContent = 'Generating plan... This may take a moment.';
        generatePlanBtn.disabled = true;
        aiPlanContainer.style.display = 'none';

        const systemPrompt = `You are the "Area 59 Makerspace AI Assistant". Your role is to help our members plan their projects using the equipment we have available.

Here is the complete inventory of tools and machines available at Area 59:
${JSON.stringify(inventoryData, null, 2)}

A user has submitted a project idea. Your tasks are:
1.  **Analyze the project:** Based on the user's description and optional image, understand what they want to create.
2.  **Generate a structured project plan:** Provide a detailed plan including a project name, description, estimated skill level, design considerations, required skills with proficiency, a list of materials and tools, a step-by-step plan broken into phases, and critical safety warnings.
    - **Important:** Your safety warning must ALWAYS conclude with the sentence: "Area 59 requires all members to be trained and certified on a machine before use."
3.  **Perform a Feasibility Analysis:** This is the most critical step. Compare the tools required for the project against the provided Area 59 inventory.
    -   Determine if the project is Fully Feasible, Partially Feasible, or Not Feasible with our equipment.
    -   Provide a clear explanation for your rating.
    -   List the key tools required and explicitly state whether each is available in our inventory. Your analysis must ONLY reference tools from the provided inventory list.
4.  **Respond in JSON format:** Your entire response must be a single JSON object that matches the provided schema. Do not include any text or markdown formatting outside of the JSON object.`;

        const userPrompt = userDescriptionInput.value.trim();
        
        const payloadParts = [{ text: userPrompt }];
        if (imageBase64) {
            payloadParts.push({ inlineData: { mimeType: "image/jpeg", data: imageBase64 } });
        }

        const payload = {
            contents: [{ parts: payloadParts }],
            systemInstruction: { parts: [{ text: systemPrompt }] },
            generationConfig: {
                responseMimeType: "application/json",
                responseSchema: {
                    type: "OBJECT",
                    properties: {
                        projectName: { type: "STRING" },
                        projectDescription: { type: "STRING" },
                        skillLevel: { type: "STRING", enum: ["Beginner", "Intermediate", "Advanced"] },
                        designConsiderations: { type: "ARRAY", items: { type: "STRING" } },
                        requiredSkills: { type: "ARRAY", items: { type: "OBJECT", properties: { skill: { type: "STRING" }, level: { type: "STRING", enum: ["Beginner", "Intermediate", "Advanced"] } } } },
                        materials: { type: "ARRAY", items: { type: "STRING" } },
                        tools: { type: "ARRAY", items: { type: "STRING" } },
                        plan: { type: "ARRAY", items: { type: "OBJECT", properties: { phase: { type: "STRING" }, steps: { type: "ARRAY", items: { type: "STRING" } } } } },
                        safetyWarning: { type: "STRING" },
                        feasibility: {
                           type: "OBJECT",
                           properties: {
                               rating: { type: "STRING", enum: ["Fully Feasible", "Partially Feasible", "Not Feasible"] },
                               explanation: { type: "STRING" },
                               requiredTools: { type: "ARRAY", items: { type: "OBJECT", properties: { toolName: { type: "STRING" }, available: { type: "BOOLEAN" } } } }
                           }
                        }
                    }
                }
            }
        };

        try {
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                const errorBody = await response.json();
                throw new Error(`API Error: ${errorBody.error?.message || response.statusText} (${response.status})`);
            }

            const result = await response.json();
            const jsonText = result.candidates[0].content.parts[0].text;
            const planData = JSON.parse(jsonText);
            
            displayAIPlan(planData);
            statusMessage.textContent = 'Plan generated successfully!';

        } catch (error) {
            console.error('Error generating plan:', error);
            statusMessage.textContent = `Error: ${error.message}`;
        } finally {
            generatePlanBtn.disabled = false;
        }
    }

    function displayAIPlan(data) {
        // --- Render Overview ---
        const overviewContainer = document.getElementById('overview');
        const skillColors = { "Beginner": "bg-green-100 text-green-800", "Intermediate": "bg-yellow-100 text-yellow-800", "Advanced": "bg-red-100 text-red-800" };
        
        overviewContainer.innerHTML = `
            <h2 class="text-3xl font-bold">${data.projectName}</h2>
            <p>${data.projectDescription}</p>
            
            ${inventoryData ? `
            <div class="p-4 rounded-lg bg-slate-100 border border-slate-200">
                <h3 class="text-xl font-semibold mb-3">Feasibility at Area 59</h3>
                <p class="mb-1"><span class="font-bold">Rating:</span> ${data.feasibility.rating}</p>
                <p class="mb-4">${data.feasibility.explanation}</p>
                <h4 class="font-semibold mb-2">Key Equipment Check:</h4>
                <ul class="space-y-1">
                    ${data.feasibility.requiredTools.map(t => `
                        <li class="flex items-center gap-2">${t.available ? '<span class="text-green-500">✔</span>' : '<span class="text-red-500">✖</span>'} ${t.toolName}</li>
                    `).join('')}
                </ul>
            </div>` : ''}

            <div class="p-4 rounded-lg bg-slate-100 border border-slate-200">
                 <h3 class="text-xl font-semibold mb-2">Details</h3>
                 <p><span class="font-bold">Overall Skill Level:</span> <span class="skill-badge ${skillColors[data.skillLevel] || ''}">${data.skillLevel}</span></p>
            </div>

            <div class="p-4 rounded-lg bg-slate-100 border border-slate-200">
                <h3 class="text-xl font-semibold mb-2">Required Skills</h3>
                <div class="flex flex-wrap gap-2">
                    ${data.requiredSkills.map(s => `<span class="skill-badge ${skillColors[s.level] || ''}">${s.skill} (${s.level})</span>`).join('')}
                </div>
            </div>

            <div class="p-4 rounded-lg bg-slate-100 border border-slate-200">
                <h3 class="text-xl font-semibold mb-2">Design Considerations</h3>
                <ul class="list-disc list-inside space-y-1">${data.designConsiderations.map(c => `<li>${c}</li>`).join('')}</ul>
            </div>
        `;
        
        // --- Render Materials & Tools ---
        const materialsContainer = document.getElementById('materials');
        materialsContainer.innerHTML = `
            <div>
                <h3 class="text-2xl font-semibold mb-2">Materials</h3>
                <ul class="list-disc list-inside space-y-1">${data.materials.map(m => `<li>${m}</li>`).join('')}</ul>
            </div>
            <div>
                <h3 class="text-2xl font-semibold mb-2">Tools</h3>
                <ul class="list-disc list-inside space-y-1">${data.tools.map(t => `<li>${t}</li>`).join('')}</ul>
            </div>
        `;

        // --- Render Plan ---
        const planContainer = document.getElementById('plan');
        planContainer.innerHTML = data.plan.map(phase => `
            <div>
                <h3 class="text-2xl font-semibold mb-2">${phase.phase}</h3>
                <ol class="list-decimal list-inside space-y-2">${phase.steps.map(step => `<li>${step}</li>`).join('')}</ol>
            </div>
        `).join('<hr class="my-6">');
        
        // --- Render Safety ---
        const safetyContainer = document.getElementById('safety');
        safetyContainer.innerHTML = `
            <div class="p-4 rounded-lg bg-red-50 border border-red-200">
                <h3 class="text-2xl font-semibold text-red-800 mb-2">⚠️ Safety Warning</h3>
                <p class="text-red-700">${data.safetyWarning}</p>
            </div>
        `;

        // Show container and setup tabs
        aiPlanContainer.style.display = 'block';
        setupTabs();
    }

    function setupTabs() {
        const tabButtons = document.querySelectorAll('.tab-button');
        const tabContents = document.querySelectorAll('.tab-content');
        
        tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                tabButtons.forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');
                
                tabContents.forEach(content => content.classList.remove('active'));
                document.getElementById(button.dataset.tab).classList.add('active');
            });
        });
    }

</script>
</body>
</html>

