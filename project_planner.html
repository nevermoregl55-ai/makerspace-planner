<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Area 59 - AI Project Planner</title>
    <script src="https://cdn.tailwindcss.com/"></script>
    <style>
        body {
            background-image: url('GCC-Sunset-7.jpg');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
        }
        .content-panel, .settings-panel {
            background-color: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
        }
        #ai-plan-container, #settings-modal { display: none; }
        .tab-button {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
        }
        .tab-button.active {
            background-color: #2563eb;
            color: white;
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .image-preview-container {
            width: 200px;
            height: 200px;
            border: 2px dashed #9ca3af;
            border-radius: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: rgba(255, 255, 255, 0.2);
            overflow: hidden;
            cursor: pointer;
        }
        .image-preview-container img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .skill-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.875rem;
            font-weight: 500;
        }
    </style>
</head>
<body class="text-slate-800">

    <!-- Settings Modal -->
    <div id="settings-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="settings-panel rounded-2xl shadow-lg p-8 w-full max-w-lg space-y-4">
            <h2 class="text-2xl font-bold text-slate-900">Settings</h2>
            <div>
                <label for="api-key-input" class="block text-sm font-medium text-slate-700">Google AI API Key</label>
                <input type="password" id="api-key-input" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm">
                <p class="text-xs text-slate-500 mt-1">Your key is saved securely in your browser's local storage.</p>
            </div>
            <div class="flex justify-end gap-4">
                <button id="cancel-settings-btn" class="px-4 py-2 font-semibold text-slate-700 bg-slate-200 rounded-lg hover:bg-slate-300">Cancel</button>
                <button id="save-settings-btn" class="px-4 py-2 font-semibold text-white bg-blue-600 rounded-lg hover:bg-blue-700">Save Key</button>
            </div>
        </div>
    </div>

    <div class="container mx-auto max-w-5xl p-4 sm:p-6 md:p-8">
        <header class="text-center mb-8 relative p-6 rounded-xl content-panel shadow-md">
            <a href="index.html"><img src="Area_59_Logo_Color_3x1.png" alt="Area 59 Logo" class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 h-24 opacity-40 pointer-events-none"></a>
            <div class="relative">
                <h1 class="text-4xl font-bold text-slate-900">AI Project Planner</h1>
                <p class="text-slate-700 mt-2 max-w-3xl mx-auto">Welcome to the Area 59 AI Project Planner! Describe your project idea, upload an optional image, and our AI will generate a comprehensive plan tailored to the tools and equipment available in our makerspace.</p>
            </div>
            <button id="open-settings-btn" title="Settings" class="absolute top-4 right-4 text-2xl text-slate-600 hover:text-slate-900 transition">⚙️</button>
        </header>

         <div id="api-key-banner" class="hidden bg-yellow-100 border-l-4 border-yellow-500 text-yellow-800 p-4 rounded-lg mb-6" role="alert">
             <p class="font-bold">Google AI API Key Required</p>
             <p>To use the AI Planner, you need a free API key from Google AI Studio. Click the ⚙️ icon in the top right to add your key. <a href="https://aistudio.google.com/app/apikey" target="_blank" class="font-bold underline hover:text-yellow-900">Get your free key here.</a></p>
        </div>
         <div id="inventory-error-banner" class="hidden bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded-lg mb-6" role="alert">
             <p class="font-bold">Inventory Error</p>
             <p>Could not load the makerspace inventory file. The feasibility check will be disabled.</p>
        </div>


        <!-- Input Section -->
        <div class="content-panel p-8 rounded-xl shadow-lg">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                <div class="md:col-span-2 space-y-4">
                    <h2 class="text-2xl font-semibold">Describe Your Project</h2>
                    <textarea id="user-description-input" rows="8" class="w-full p-3 rounded-lg border border-slate-300 shadow-sm focus:ring-2 focus:ring-blue-500 focus:outline-none" placeholder="e.g., I want to build a small bookshelf out of plywood..."></textarea>
                </div>
                <div class="space-y-4 flex flex-col items-center">
                    <h2 class="text-2xl font-semibold">Upload an Image (Optional)</h2>
                    <div id="image-preview" class="image-preview-container">
                        <span id="image-placeholder" class="text-slate-500">Click to upload</span>
                    </div>
                    <input type="file" id="image-upload-input" class="hidden" accept="image/*">
                    <button id="upload-button" class="w-full px-4 py-2 font-semibold text-white bg-slate-600 rounded-lg hover:bg-slate-700">Choose Image</button>
                </div>
            </div>
            <div class="text-center mt-8">
                <button id="generate-plan-btn" class="px-8 py-4 font-bold text-xl text-white bg-blue-600 rounded-lg hover:bg-blue-700 disabled:bg-slate-400 transition shadow-lg">Generate Plan</button>
                <p id="status-message" class="mt-4 text-slate-600 font-medium h-6"></p>
            </div>
        </div>

        <!-- AI Plan Display -->
        <div id="ai-plan-container" class="mt-8 content-panel p-8 rounded-xl shadow-lg">
             <div class="flex flex-wrap gap-2 mb-6 border-b border-slate-300 pb-4">
                <button class="tab-button active" data-tab="overview">Overview</button>
                <button class="tab-button" data-tab="materials">Materials & Tools</button>
                <button class="tab-button" data-tab="plan">Step-by-Step Plan</button>
                <button class="tab-button" data-tab="safety">Safety</button>
            </div>
            <div id="overview" class="tab-content active space-y-6"></div>
            <div id="materials" class="tab-content space-y-6"></div>
            <div id="plan" class="tab-content space-y-6"></div>
            <div id="safety" class="tab-content space-y-6"></div>
        </div>
    </div>

<script type="module">
    let apiKey = '';
    let imageBase64 = null;
    let inventoryData = null;

    const userDescriptionInput = document.getElementById('user-description-input');
    const imageUploadInput = document.getElementById('image-upload-input');
    const uploadButton = document.getElementById('upload-button');
    const imagePreview = document.getElementById('image-preview');
    const generatePlanBtn = document.getElementById('generate-plan-btn');
    const statusMessage = document.getElementById('status-message');
    const aiPlanContainer = document.getElementById('ai-plan-container');
    const inventoryErrorBanner = document.getElementById('inventory-error-banner');
    const apiKeyBanner = document.getElementById('api-key-banner');
    const settingsModal = document.getElementById('settings-modal');
    const apiKeyInput = document.getElementById('api-key-input');
    
    document.addEventListener('DOMContentLoaded', () => {
        apiKey = localStorage.getItem('googleAiApiKey') || '';
        if (apiKey) {
            apiKeyInput.value = apiKey;
        } else {
            apiKeyBanner.classList.remove('hidden');
        }
        loadInventory();
        checkGenerateButtonState();
    });

    async function loadInventory() {
        try {
            const response = await fetch(`inventory.json`);
            if (!response.ok) throw new Error('Network response was not ok');
            inventoryData = await response.json();
        } catch (error) {
            console.error("Failed to load inventory:", error);
            inventoryErrorBanner.classList.remove('hidden');
            inventoryData = null;
        }
    }

    document.getElementById('open-settings-btn').addEventListener('click', () => settingsModal.style.display = 'flex');
    document.getElementById('cancel-settings-btn').addEventListener('click', () => settingsModal.style.display = 'none');
    document.getElementById('save-settings-btn').addEventListener('click', () => {
        apiKey = apiKeyInput.value.trim();
        if (apiKey) {
            localStorage.setItem('googleAiApiKey', apiKey);
            settingsModal.style.display = 'none';
            apiKeyBanner.classList.add('hidden');
            checkGenerateButtonState();
            statusMessage.textContent = "API Key saved successfully!";
            setTimeout(() => statusMessage.textContent = '', 3000);
        }
    });

    uploadButton.addEventListener('click', () => imageUploadInput.click());
    imagePreview.addEventListener('click', () => imageUploadInput.click());

    imageUploadInput.addEventListener('change', (event) => {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                imageBase64 = e.target.result.split(',')[1];
                imagePreview.innerHTML = `<img src="${e.target.result}" alt="Project preview">`;
            };
            reader.readAsDataURL(file);
        }
    });

    userDescriptionInput.addEventListener('input', checkGenerateButtonState);
    generatePlanBtn.addEventListener('click', generatePlan);

    function checkGenerateButtonState() {
        generatePlanBtn.disabled = !userDescriptionInput.value.trim() || !apiKey;
    }

    async function generatePlan() {
        statusMessage.textContent = 'Generating plan... This may take a moment.';
        generatePlanBtn.disabled = true;
        aiPlanContainer.style.display = 'none';

        const systemPrompt = `You are the "Area 59 Makerspace AI Assistant". Your role is to help our members plan their projects using the equipment we have available.
        Here is the complete inventory of tools and machines available at Area 59:
        ${JSON.stringify(inventoryData, null, 2)}
        A user has submitted a project idea. Your tasks are:
        1. **Analyze the project:** Based on the user's description and optional image, understand what they want to create.
        2. **Generate a structured project plan:** Provide a detailed plan including a project name, description, estimated skill level, design considerations, required skills with proficiency, a list of materials and tools, a step-by-step plan broken into phases, and critical safety warnings.
           - **Important:** Your safety warning must ALWAYS conclude with the sentence: "Area 59 requires all members to be trained and certified on a machine before use."
        3. **Perform a Feasibility Analysis:** This is the most critical step. Compare the tools required for the project against the provided Area 59 inventory.
           - Determine if the project is Fully Feasible, Partially Feasible, or Not Feasible with our equipment.
           - Provide a clear explanation for your rating.
           - List the key tools required and explicitly state whether each is available in our inventory. Your analysis must ONLY reference tools from the provided inventory list.
        4. **Respond in JSON format:** Your entire response must be a single JSON object that matches the provided schema. Do not include any text or markdown formatting outside of the JSON object.`;
        
        const payloadParts = [{ text: userDescriptionInput.value.trim() }];
        if (imageBase64) {
            payloadParts.push({ inlineData: { mimeType: "image/jpeg", data: imageBase64 } });
        }

        const payload = {
            contents: [{ parts: payloadParts }],
            systemInstruction: { parts: [{ text: systemPrompt }] },
            generationConfig: {
                responseMimeType: "application/json",
                responseSchema: {
                    type: "OBJECT",
                    properties: {
                        projectName: { type: "STRING" },
                        projectDescription: { type: "STRING" },
                        skillLevel: { type: "STRING", enum: ["Beginner", "Intermediate", "Advanced"] },
                        designConsiderations: { type: "ARRAY", items: { type: "STRING" } },
                        requiredSkills: { type: "ARRAY", items: { type: "OBJECT", properties: { skill: { type: "STRING" }, level: { type: "STRING", enum: ["Beginner", "Intermediate", "Advanced"] } } } },
                        materials: { type: "ARRAY", items: { type: "STRING" } },
                        tools: { type: "ARRAY", items: { type: "STRING" } },
                        plan: { type: "ARRAY", items: { type: "OBJECT", properties: { phase: { type: "STRING" }, steps: { type: "ARRAY", items: { type: "STRING" } } } } },
                        safetyWarning: { type: "STRING" },
                        feasibility: {
                           type: "OBJECT",
                           properties: {
                               rating: { type: "STRING", enum: ["Fully Feasible", "Partially Feasible", "Not Feasible"] },
                               explanation: { type: "STRING" },
                               requiredTools: { type: "ARRAY", items: { type: "OBJECT", properties: { toolName: { type: "STRING" }, available: { type: "BOOLEAN" } } } }
                           }
                        }
                    }
                }
            }
        };

        try {
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                const errorBody = await response.json();
                throw new Error(errorBody.error?.message || `HTTP error! status: ${response.status}`);
            }

            const result = await response.json();
            let jsonText = result.candidates[0].content.parts[0].text;
            
            // **FIX:** Clean the response to remove markdown wrappers
            jsonText = jsonText.replace(/^```json\s*/, '').replace(/```$/, '');
            
            const planData = JSON.parse(jsonText);
            
            displayAIPlan(planData);
            statusMessage.textContent = 'Plan generated successfully!';

        } catch (error) {
            console.error('Error generating plan:', error);
            statusMessage.textContent = `Error: ${error.message}`;
        } finally {
            generatePlanBtn.disabled = false;
        }
    }

    function displayAIPlan(data) {
        // --- Render Overview ---
        const overviewContainer = document.getElementById('overview');
        const skillColors = { "Beginner": "bg-green-100 text-green-800", "Intermediate": "bg-yellow-100 text-yellow-800", "Advanced": "bg-red-100 text-red-800" };
        
        overviewContainer.innerHTML = `
            <h2 class="text-3xl font-bold">${data.projectName}</h2>
            <p>${data.projectDescription}</p>
            
            ${inventoryData ? `
            <div class="p-4 rounded-lg bg-slate-100 border border-slate-200">
                <h3 class="text-xl font-semibold mb-3">Feasibility at Area 59</h3>
                <p class="mb-1"><span class="font-bold">Rating:</span> ${data.feasibility.rating}</p>
                <p class="mb-4">${data.feasibility.explanation}</p>
                <h4 class="font-semibold mb-2">Key Equipment Check:</h4>
                <ul class="space-y-1">
                    ${(data.feasibility.requiredTools || []).map(t => `
                        <li class="flex items-center gap-2">${t.available ? '<span class="text-green-500">✔</span>' : '<span class="text-red-500">✖</span>'} ${t.toolName}</li>
                    `).join('')}
                </ul>
            </div>` : ''}

            <div class="p-4 rounded-lg bg-slate-100 border border-slate-200">
                 <h3 class="text-xl font-semibold mb-2">Details</h3>
                 <p><span class="font-bold">Overall Skill Level:</span> <span class="skill-badge ${skillColors[data.skillLevel] || ''}">${data.skillLevel}</span></p>
            </div>

            <div class="p-4 rounded-lg bg-slate-100 border border-slate-200">
                <h3 class="text-xl font-semibold mb-2">Required Skills</h3>
                <div class="flex flex-wrap gap-2">
                    ${(data.requiredSkills || []).map(s => `<span class="skill-badge ${skillColors[s.level] || ''}">${s.skill} (${s.level})</span>`).join('')}
                </div>
            </div>

            <div class="p-4 rounded-lg bg-slate-100 border border-slate-200">
                <h3 class="text-xl font-semibold mb-2">Design Considerations</h3>
                <ul class="list-disc list-inside space-y-1">${(data.designConsiderations || []).map(c => `<li>${c}</li>`).join('')}</ul>
            </div>
        `;
        
        // --- Render Materials & Tools ---
        const materialsContainer = document.getElementById('materials');
        materialsContainer.innerHTML = `
            <div>
                <h3 class="text-2xl font-semibold mb-2">Materials</h3>
                <ul class="list-disc list-inside space-y-1">${(data.materials || []).map(m => `<li>${m}</li>`).join('')}</ul>
            </div>
            <div>
                <h3 class="text-2xl font-semibold mb-2">Tools</h3>
                <ul class="list-disc list-inside space-y-1">${(data.tools || []).map(t => `<li>${t}</li>`).join('')}</ul>
            </div>
        `;

        // --- Render Plan ---
        const planContainer = document.getElementById('plan');
        planContainer.innerHTML = (data.plan || []).map(phase => `
            <div>
                <h3 class="text-2xl font-semibold mb-2">${phase.phase}</h3>
                <ol class="list-decimal list-inside space-y-2">${(phase.steps || []).map(step => `<li>${step}</li>`).join('')}</ol>
            </div>
        `).join('<hr class="my-6">');
        
        // --- Render Safety ---
        const safetyContainer = document.getElementById('safety');
        safetyContainer.innerHTML = `
            <div class="p-4 rounded-lg bg-red-50 border border-red-200">
                <h3 class="text-2xl font-semibold text-red-800 mb-2">⚠️ Safety Warning</h3>
                <p class="text-red-700">${data.safetyWarning}</p>
            </div>
        `;
        
        aiPlanContainer.style.display = 'block';
        setupTabs();
    }

    function setupTabs() {
        const tabButtons = document.querySelectorAll('.tab-button');
        const tabContents = document.querySelectorAll('.tab-content');
        
        tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                tabButtons.forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');
                tabContents.forEach(content => content.classList.remove('active'));
                document.getElementById(button.dataset.tab).classList.add('active');
            });
        });
    }

</script>
</body>
</html>

