<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Area 59 - Appointments</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #f1f5f9; }
        .calendar-day { min-height: 120px; }
        .timeslot {
            font-size: 0.8rem;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            color: white;
            margin-top: 0.25rem;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
            position: relative; /* Needed for delete button */
        }
        .timeslot.approved { background-color: #ef4444; } /* red-500 */
        .timeslot.walk-in { background-color: #22c55e; } /* green-500 */
        .delete-btn {
            position: absolute;
            top: 2px;
            right: 4px;
            font-size: 1.2rem;
            line-height: 1;
            font-weight: bold;
            color: white;
            opacity: 0.7;
            cursor: pointer;
            display: none; /* Hidden by default */
        }
        .delete-btn:hover { opacity: 1; }
        body.admin-mode .delete-btn { display: block; } /* Show in admin mode */
        #request-modal, #admin-login-modal, #walk-in-modal { display: none; }
    </style>
</head>
<body class="text-slate-800">

    <!-- Admin Login Modal -->
    <div id="admin-login-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-2xl shadow-lg p-8 w-full max-w-sm space-y-4">
            <h2 class="text-xl font-bold text-center">Admin Login</h2>
            <form id="admin-login-form">
                <input type="password" id="admin-password" placeholder="Password" required class="w-full px-4 py-2 rounded-lg border-slate-300">
                <div class="flex gap-4 mt-4">
                    <button type="button" id="cancel-admin-login" class="w-full py-2 bg-slate-200 rounded-lg">Cancel</button>
                    <button type="submit" class="w-full py-2 bg-blue-600 text-white rounded-lg">Login</button>
                </div>
                <p id="admin-login-error" class="text-red-500 text-sm text-center hidden mt-2">Incorrect password.</p>
            </form>
        </div>
    </div>

    <!-- Add Walk-in Modal (Admin only) -->
    <div id="walk-in-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-2xl shadow-lg p-8 w-full max-w-lg space-y-4">
             <h2 class="text-2xl font-bold text-slate-900">Add Walk-in Slot</h2>
             <form id="walk-in-form" class="space-y-4">
                 <input type="hidden" id="walk-in-date">
                 <div class="grid grid-cols-2 gap-4">
                    <div>
                       <label for="walk-in-start-time" class="block text-sm font-medium">Start Time</label>
                       <input type="time" id="walk-in-start-time" required class="mt-1 block w-full rounded-md border-slate-300">
                    </div>
                    <div>
                       <label for="walk-in-end-time" class="block text-sm font-medium">End Time</label>
                       <input type="time" id="walk-in-end-time" required class="mt-1 block w-full rounded-md border-slate-300">
                    </div>
                 </div>
                 <div class="flex justify-end gap-4 pt-4">
                    <button type="button" id="cancel-walk-in-btn" class="px-4 py-2 font-semibold bg-slate-200 rounded-lg">Cancel</button>
                    <button type="submit" id="submit-walk-in-btn" class="px-4 py-2 font-semibold text-white bg-blue-600 rounded-lg">Add Slot</button>
                 </div>
             </form>
        </div>
    </div>

    <!-- Request Modal -->
    <div id="request-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-2xl shadow-lg p-8 w-full max-w-lg space-y-4">
             <h2 class="text-2xl font-bold text-slate-900">Request Appointment</h2>
             <form id="request-form" class="space-y-4">
                 <input type="hidden" id="request-date">
                 <div>
                    <label for="machine-select" class="block text-sm font-medium">Machine</label>
                    <select id="machine-select" required class="mt-1 block w-full rounded-md border-slate-300">
                        <option>Loading inventory...</option>
                    </select>
                 </div>
                 <div class="grid grid-cols-2 gap-4">
                    <div>
                       <label for="start-time" class="block text-sm font-medium">Start Time</label>
                       <input type="time" id="start-time" required class="mt-1 block w-full rounded-md border-slate-300">
                    </div>
                    <div>
                       <label for="end-time" class="block text-sm font-medium">End Time</label>
                       <input type="time" id="end-time" required class="mt-1 block w-full rounded-md border-slate-300">
                    </div>
                 </div>
                 <div>
                    <label for="member-name" class="block text-sm font-medium">Your Name</label>
                    <input type="text" id="member-name" required class="mt-1 block w-full rounded-md border-slate-300">
                 </div>
                 <div>
                    <label for="member-email" class="block text-sm font-medium">Your Email</label>
                    <input type="email" id="member-email" required class="mt-1 block w-full rounded-md border-slate-300">
                 </div>
                 <div class="flex justify-end gap-4 pt-4">
                    <button type="button" id="cancel-request-btn" class="px-4 py-2 font-semibold bg-slate-200 rounded-lg">Cancel</button>
                    <button type="submit" id="submit-request-btn" class="px-4 py-2 font-semibold text-white bg-blue-600 rounded-lg">Submit Request</button>
                 </div>
             </form>
             <p id="success-message" class="hidden text-center text-green-600 font-semibold">Request sent! You will be notified upon approval.</p>
        </div>
    </div>


    <div class="container mx-auto p-4 sm:p-6 md:p-8">
        <header class="text-center mb-8 relative">
             <a href="index.html"><img src="Area_59_Logo_Color_3x1.png" alt="Area 59 Logo" class="mx-auto h-20 mb-4"></a>
            <h1 class="text-4xl font-bold text-slate-900">Machine Schedule</h1>
            <p class="text-slate-600 mt-2">View the calendar for machine availability and click a day to request a time slot.</p>
             <div class="mt-4 flex justify-center gap-4 text-sm">
                <span class="flex items-center gap-2"><div class="w-4 h-4 rounded-full bg-red-500"></div> Booked Appointment</span>
                <span class="flex items-center gap-2"><div class="w-4 h-4 rounded-full bg-green-500"></div> Walk-in Hours</span>
            </div>
            <button id="admin-login-btn" class="absolute top-0 right-0 text-sm text-slate-500 hover:text-slate-800">Admin</button>
        </header>

         <div class="flex items-center justify-center mb-6 gap-4">
            <button id="prev-month" class="px-4 py-2 bg-white rounded-lg shadow font-semibold">&larr;</button>
            <h2 id="month-year" class="text-2xl font-bold"></h2>
            <button id="next-month" class="px-4 py-2 bg-white rounded-lg shadow font-semibold">&rarr;</button>
        </div>

        <div id="calendar" class="grid grid-cols-7 gap-px bg-slate-200 border border-slate-200"></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, getDocs, doc, getDoc, addDoc, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyA30A5Qh43IVxy0ZJnVTW9rtvYZG7Cp8-s",
            authDomain: "area-59-makerspace.firebaseapp.com",
            projectId: "area-59-makerspace",
            storageBucket: "area-59-makerspace.firebasestorage.app",
            messagingSenderId: "721728366959",
            appId: "1:721728366959:web:8a6513baa852e5699b609a",
            measurementId: "G-8RFF3XJWFL"
        };
        
        let db, currentDate = new Date(), appointments = [], walkInHours = [], inventory = {};

        async function initialize() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                const auth = getAuth(app);
                await signInAnonymously(auth);
                
                await Promise.all([loadAppointments(), loadInventory(), loadWalkInHours()]);
                
                populateMachineSelect();
                renderCalendar();
            } catch (error) { 
                console.error("Firebase Init Error:", error); 
                document.getElementById('calendar').innerHTML = `<p class="text-red-500 col-span-7 text-center p-4">Could not connect to the scheduling service.</p>`;
            }
        }

        async function loadAppointments() {
            appointments = [];
            const querySnapshot = await getDocs(collection(db, "public_appointments"));
            querySnapshot.forEach((doc) => {
                appointments.push({ id: doc.id, ...doc.data() });
            });
        }

        async function loadInventory() {
            const docRef = doc(db, "inventory", "main");
            const docSnap = await getDoc(docRef);
            if (docSnap.exists()) {
                inventory = docSnap.data().data;
            }
        }
        
         async function loadWalkInHours() {
            walkInHours = [];
            const docRef = doc(db, "walk_in_hours", "schedule");
            const docSnap = await getDoc(docRef);
            if (docSnap.exists()) walkInHours = docSnap.data().hours;
        }

        function populateMachineSelect() {
            const select = document.getElementById('machine-select');
            select.innerHTML = '';
            
            for (const category in inventory) {
                const items = inventory[category].machines || inventory[category].items || [];
                if (items.length > 0) {
                    const optgroup = document.createElement('optgroup');
                    optgroup.label = category;
                    items.forEach(item => {
                        const option = document.createElement('option');
                        option.value = item;
                        option.textContent = item;
                        optgroup.appendChild(option);
                    });
                    select.appendChild(optgroup);
                }
            }
        }
        
        function renderCalendar() {
            const calendarEl = document.getElementById('calendar');
            calendarEl.innerHTML = '';
            
            const month = currentDate.getMonth();
            const year = currentDate.getFullYear();
            
            document.getElementById('month-year').textContent = `${currentDate.toLocaleString('default', { month: 'long' })} ${year}`;

            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            
            ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].forEach(day => {
                calendarEl.innerHTML += `<div class="text-center font-bold p-2 bg-slate-100">${day}</div>`;
            });

            for (let i = 0; i < firstDay; i++) calendarEl.appendChild(document.createElement('div'));

            for (let day = 1; day <= daysInMonth; day++) {
                const dayEl = document.createElement('div');
                dayEl.className = 'calendar-day p-2 bg-white relative hover:bg-slate-50 cursor-pointer';
                dayEl.dataset.day = day;
                dayEl.innerHTML = `<span class="font-semibold">${day}</span>`;

                const todayStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                
                const dayWalkIn = walkInHours.filter(h => h.date === todayStr);
                dayWalkIn.forEach(walk => {
                    const walkInDiv = document.createElement('div');
                    walkInDiv.className = 'timeslot walk-in';
                    walkInDiv.innerHTML = `Walk-in: ${walk.startTime} - ${walk.endTime} <span class="delete-btn" data-id="${walk.date}_${walk.startTime}" data-type="walk-in">&times;</span>`;
                    dayEl.appendChild(walkInDiv);
                });

                const dayAppts = appointments.filter(a => a.date === todayStr);
                dayAppts.sort((a,b) => a.startTime.localeCompare(b.startTime));
                dayAppts.forEach(appt => {
                    const apptDiv = document.createElement('div');
                    apptDiv.className = 'timeslot approved';
                    apptDiv.title = `${appt.name} - ${appt.machine}`;
                    apptDiv.innerHTML = `${appt.startTime} - ${appt.machine} <span class="delete-btn" data-id="${appt.id}" data-type="appointment">&times;</span>`;
                    dayEl.appendChild(apptDiv);
                });
                
                calendarEl.appendChild(dayEl);
            }
        }
        
        // --- Modal Logic ---
        const requestModal = document.getElementById('request-modal');
        const walkInModal = document.getElementById('walk-in-modal');

        document.getElementById('calendar').addEventListener('click', (e) => {
            const dayEl = e.target.closest('.calendar-day');
            if (dayEl) {
                const date = new Date(currentDate.getFullYear(), currentDate.getMonth(), parseInt(dayEl.dataset.day));
                const dateString = date.toISOString().split('T')[0];

                if (document.body.classList.contains('admin-mode')) {
                    // Admin clicks a day to add a walk-in
                    if (!e.target.classList.contains('delete-btn')) {
                        document.getElementById('walk-in-date').value = dateString;
                        walkInModal.style.display = 'flex';
                    }
                } else {
                    // Public user clicks a day to request appointment
                    document.getElementById('request-date').value = dateString;
                    requestModal.style.display = 'flex';
                }
            }
        });

        // Event listener for all delete buttons
        document.getElementById('calendar').addEventListener('click', async e => {
            if (e.target.classList.contains('delete-btn')) {
                const { id, type } = e.target.dataset;
                if (type === 'appointment' && confirm("Delete this appointment?")) {
                    await deleteDoc(doc(db, "public_appointments", id));
                } else if (type === 'walk-in' && confirm("Delete this walk-in slot?")) {
                    const [date, startTime] = id.split('_');
                    await deleteWalkIn(date, startTime);
                }
                await Promise.all([loadAppointments(), loadWalkInHours()]);
                renderCalendar();
            }
        });


        // Appointment Request Modal
        document.getElementById('cancel-request-btn').addEventListener('click', () => requestModal.style.display = 'none');
        document.getElementById('request-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const submitBtn = document.getElementById('submit-request-btn');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Submitting...';

            const request = {
                date: document.getElementById('request-date').value,
                machine: document.getElementById('machine-select').value,
                startTime: document.getElementById('start-time').value,
                endTime: document.getElementById('end-time').value,
                name: document.getElementById('member-name').value,
                email: document.getElementById('member-email').value,
                isMember: true,
                status: 'pending'
            };

            try {
                await addDoc(collection(db, "pending_appointments"), request);
                document.getElementById('success-message').classList.remove('hidden');
                setTimeout(() => {
                    requestModal.style.display = 'none';
                    document.getElementById('success-message').classList.add('hidden');
                    document.getElementById('request-form').reset();
                }, 3000);
            } catch (error) {
                console.error("Error submitting request:", error);
                alert("Failed to submit request. Please try again.");
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Submit Request';
            }
        });

        // Walk-in Modal
        document.getElementById('cancel-walk-in-btn').addEventListener('click', () => walkInModal.style.display = 'none');
        document.getElementById('walk-in-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const newWalkIn = {
                date: document.getElementById('walk-in-date').value,
                startTime: document.getElementById('walk-in-start-time').value,
                endTime: document.getElementById('walk-in-end-time').value,
            };

            const docRef = doc(db, "walk_in_hours", "schedule");
            const docSnap = await getDoc(docRef);
            let hours = docSnap.exists() ? docSnap.data().hours : [];
            hours.push(newWalkIn);
            await updateDoc(docRef, { hours });

            walkInModal.style.display = 'none';
            await loadWalkInHours();
            renderCalendar();
        });
        
        // Admin Login
        const adminLoginBtn = document.getElementById('admin-login-btn');
        const adminModal = document.getElementById('admin-login-modal');
        adminLoginBtn.addEventListener('click', () => adminModal.style.display = 'flex');
        document.getElementById('cancel-admin-login').addEventListener('click', () => adminModal.style.display = 'none');
        document.getElementById('admin-login-form').addEventListener('submit', e => {
            e.preventDefault();
            if (document.getElementById('admin-password').value === "Pronghorn@59") {
                document.body.classList.add('admin-mode');
                adminModal.style.display = 'none';
                document.getElementById('admin-login-error').classList.add('hidden');
                document.getElementById('admin-password').value = '';
            } else {
                document.getElementById('admin-login-error').classList.remove('hidden');
            }
        });

        async function deleteWalkIn(date, startTime) {
            const docRef = doc(db, "walk_in_hours", "schedule");
            const docSnap = await getDoc(docRef);
            if(docSnap.exists()){
                const newHours = docSnap.data().hours.filter(h => !(h.date === date && h.startTime === startTime));
                await updateDoc(docRef, { hours: newHours });
            }
        }
        
        document.getElementById('prev-month').addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth() - 1); renderCalendar(); });
        document.getElementById('next-month').addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth() + 1); renderCalendar(); });

        initialize();
    </script>
</body>
</html>
