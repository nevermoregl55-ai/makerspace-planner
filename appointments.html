<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Area 59 - Machine Appointments</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #f1f5f9; }
        .calendar-day { min-height: 120px; }
        .appointment-slot, .walk-in-slot {
            font-size: 0.8rem;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            color: white;
            margin-top: 0.25rem;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
        }
        .appointment-slot { background-color: #3b82f6; }
        .walk-in-slot { background-color: #16a34a; }
        #request-modal { display: none; }
    </style>
</head>
<body class="text-slate-800">

    <!-- Request Modal -->
    <div id="request-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-2xl shadow-lg p-8 w-full max-w-lg space-y-4 relative">
            <button id="close-modal-btn" class="absolute top-4 right-4 text-2xl font-bold text-slate-500 hover:text-slate-800">&times;</button>
            <h2 class="text-2xl font-bold text-slate-900">Request a Machine (Members)</h2>
            <form id="request-form" class="space-y-4">
                 <div>
                    <label for="userName" class="block text-sm font-medium text-slate-700">Your Name</label>
                    <input type="text" id="userName" required class="mt-1 block w-full rounded-md border-slate-300 shadow-sm">
                </div>
                <div>
                    <label for="userEmail" class="block text-sm font-medium text-slate-700">Your Email</label>
                    <input type="email" id="userEmail" required class="mt-1 block w-full rounded-md border-slate-300 shadow-sm">
                </div>
                <div>
                    <label for="machineSelect" class="block text-sm font-medium text-slate-700">Machine</label>
                    <select id="machineSelect" required class="mt-1 block w-full rounded-md border-slate-300 shadow-sm"><option>Loading...</option></select>
                </div>
                 <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="requestDate" class="block text-sm font-medium text-slate-700">Date</label>
                        <input type="date" id="requestDate" required class="mt-1 block w-full rounded-md border-slate-300 shadow-sm">
                    </div>
                    <div>
                        <label for="timeSlot" class="block text-sm font-medium text-slate-700">Time Slot</label>
                        <select id="timeSlot" required class="mt-1 block w-full rounded-md border-slate-300 shadow-sm">
                            <option value="09:00">9:00 AM - 11:00 AM</option>
                            <option value="11:00">11:00 AM - 1:00 PM</option>
                            <option value="13:00">1:00 PM - 3:00 PM</option>
                            <option value="15:00">3:00 PM - 5:00 PM</option>
                        </select>
                    </div>
                </div>
                <button type="submit" id="submit-request-btn" class="w-full px-4 py-2 font-semibold text-white bg-blue-600 rounded-lg hover:bg-blue-700">Submit Request</button>
            </form>
            <p id="success-message" class="hidden text-center text-green-600 font-semibold">Your request has been sent for approval!</p>
        </div>
    </div>

    <div class="container mx-auto p-4 sm:p-6 md:p-8">
        <header class="text-center mb-8">
            <img src="Area_59_Logo_Color_3x1.png" alt="Area 59 Logo" class="mx-auto h-20 mb-4">
            <h1 class="text-4xl font-bold text-slate-900">Machine Schedule</h1>
            <p class="text-slate-600 mt-2">View approved appointments and walk-in hours.</p>
        </header>

        <div class="flex flex-wrap justify-between items-center mb-6 gap-4">
            <div class="flex items-center gap-4">
                <button id="prev-month" class="px-4 py-2 bg-white rounded-lg shadow font-semibold">&larr;</button>
                <h2 id="month-year" class="text-2xl font-bold"></h2>
                <button id="next-month" class="px-4 py-2 bg-white rounded-lg shadow font-semibold">&rarr;</button>
            </div>
            <button id="open-modal-btn" class="px-6 py-3 font-semibold text-white bg-blue-600 rounded-lg hover:bg-blue-700 shadow-lg">Request Machine Time (Members)</button>
        </div>

        <div id="calendar" class="grid grid-cols-7 gap-px bg-slate-200 border border-slate-200"></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, getDocs, doc, getDoc, addDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
             /* PASTE YOUR FIREBASE CONFIG OBJECT HERE */
        };

        let db, currentDate = new Date(), appointments = [], walkInHours = [];

        async function initialize() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                await Promise.all([loadAppointments(), loadWalkInHours()]);
                renderCalendar();
                loadMachines();
            } catch (error) {
                console.error("Firebase Init Error:", error);
                document.getElementById('calendar').innerHTML = '<p class="text-red-500 p-4 col-span-7">Could not connect to the database.</p>';
            }
        }

        async function loadAppointments() {
            appointments = [];
            const querySnapshot = await getDocs(collection(db, "public_appointments"));
            querySnapshot.forEach((doc) => appointments.push(doc.data()));
        }

        async function loadWalkInHours() {
            const docRef = doc(db, 'walk_in_hours', 'schedule');
            const docSnap = await getDoc(docRef);
            if (docSnap.exists()) {
                walkInHours = docSnap.data().hours;
            }
        }

        function renderCalendar() {
            const calendarEl = document.getElementById('calendar');
            calendarEl.innerHTML = '';
            
            const month = currentDate.getMonth();
            const year = currentDate.getFullYear();
            
            document.getElementById('month-year').textContent = `${currentDate.toLocaleString('default', { month: 'long' })} ${year}`;

            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            
            ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].forEach(day => {
                calendarEl.innerHTML += `<div class="text-center font-bold p-2 bg-slate-100">${day}</div>`;
            });

            for (let i = 0; i < firstDay; i++) calendarEl.appendChild(document.createElement('div'));

            for (let day = 1; day <= daysInMonth; day++) {
                const dayEl = document.createElement('div');
                dayEl.className = 'calendar-day p-2 bg-white relative';
                dayEl.innerHTML = `<span class="font-semibold">${day}</span>`;

                const todayStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                
                // Render Walk-in Hours
                const walkIn = walkInHours.find(w => w.date === todayStr);
                if (walkIn) {
                    dayEl.innerHTML += `<div class="walk-in-slot" title="Walk-in Hours">Walk-ins: ${walkIn.startTime} - ${walkIn.endTime}</div>`;
                }

                // Render Appointments
                const dayAppointments = appointments.filter(app => app.date === todayStr);
                dayAppointments.sort((a, b) => a.timeSlot.localeCompare(b.timeSlot));
                dayAppointments.forEach(app => {
                    dayEl.innerHTML += `<div class="appointment-slot" title="${app.machine} - ${app.userName}">${app.machine}</div>`;
                });

                calendarEl.appendChild(dayEl);
            }
        }
        
        async function loadMachines() {
            // ... (same as before)
        }

        // --- Modal & Form Logic ---
        const modal = document.getElementById('request-modal');
        document.getElementById('open-modal-btn').addEventListener('click', () => modal.style.display = 'flex');
        document.getElementById('close-modal-btn').addEventListener('click', () => modal.style.display = 'none');
        
        document.getElementById('request-form').addEventListener('submit', async (e) => {
             e.preventDefault();
            // ... (same as before, but add `requestType: 'Member'`)
             const appointmentData = {
                userName: document.getElementById('userName').value,
                userEmail: document.getElementById('userEmail').value,
                machine: document.getElementById('machineSelect').value,
                date: document.getElementById('requestDate').value,
                timeSlot: document.getElementById('timeSlot').value,
                status: 'pending',
                requestType: 'Member', // Add this type
                requestedAt: new Date().toISOString()
            };
             // ... rest of submit logic
        });
        
        // --- Calendar Navigation ---
        // ... (same as before)

        initialize();
    </script>
</body>
</html>

